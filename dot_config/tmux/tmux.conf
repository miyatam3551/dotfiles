##### プレフィクスキー設定 ##########################################
# プレフィクスキーを Ctrl+Space に変更（CapsLockでも発動: Karabiner設定）
set -g prefix C-Space
unbind C-b
bind C-Space send-prefix

# ネストしたtmux用: Ctrl+f でリモート側にプレフィクスを送信
bind -n C-f send-prefix

# 設定リロード (prefix + r)
bind r source-file ~/.config/tmux/tmux.conf \; display "Reloaded!"

##### モード設定 ####################################################

# ESCキーの遅延をなくす（vim操作のレスポンス向上）
set -sg escape-time 0

# スクロールバック履歴の上限
set -g history-limit 10000

# SSH接続でクリップボードを有効にする
set -g set-clipboard on
set -g allow-passthrough on

# copy-mode を vi キーバインドに変更
set -g mode-keys vi

# マウス操作を有効化（ペイン切替・リサイズ・スクロール）
set -g mouse on

# ターミナルタイプを256色に設定（mac等では tmux-256color 推奨）
set -g default-terminal "tmux-256color"

# SSH_AUTH_SOCK を tmux がいじらないようにする
set -g update-environment -SSH_AUTH_SOCK

##### ウィンドウ・ペイン操作 ########################################

# ウィンドウ名を現在のディレクトリ名に自動設定
set -g automatic-rename on
set -g automatic-rename-format "#{b:pane_current_path}"

# ウィンドウ作成時に名前を指定（prefix + C）
bind C command-prompt -p "Window name:" "new-window -n '%%'"

# ペイン分割
bind \\ split-window -h   # 横分割 (右側に新ペイン)
bind | split-window -h    # 横分割 (同上、|でも可)
bind - split-window -v    # 縦分割 (下側に新ペイン)

# ウィンドウ（タブ）移動 (j: 左, k: 右)
bind j select-window -t :-1
bind k select-window -t :+1

# ダブルクリックで自動整列
bind -n DoubleClick1Pane select-layout tiled

##### クリップボード操作 #############################################

# viコピーモード設定
bind -T copy-mode-vi v send -X begin-selection
bind -T copy-mode-vi V send -X select-line
bind -T copy-mode-vi y send -X copy-pipe-and-cancel "pbcopy"

##### ステータスバー設定 (Catppuccin Mocha - 落ち着いた配色) ##############

# ステータスバー更新頻度（秒）
set -g status-interval 1

# ステータスバーを上部に配置
set -g status-position top

# ステータスバー背景（最も暗いBase色）
set -g status-style "bg=#1e1e2e,fg=#6c7086"

# 左: セッション名 + プレフィックスインジケーター
set -g status-left "#[bg=#45475a,fg=#cdd6f4,bold] #S #[bg=#1e1e2e,fg=#45475a]#{prefix_highlight}"

# ウィンドウステータス
set -g window-status-format "#[fg=#585b70] #I:#W "
set -g window-status-current-format "#[bg=#313244,fg=#89b4fa,bold] #I:#W #[bg=#1e1e2e]"
set -g window-status-separator ""

# 右: システム情報 + 日時（彩度を抑えた色）
set -g status-right-length 100
set -g status-right "#[fg=#7f849c]CPU:#{cpu_percentage} RAM:#{ram_percentage} #[fg=#45475a]│#[fg=#7f849c] #{battery_icon_status} #{battery_percentage} #[fg=#45475a]│ #[fg=#7f849c]#h #[fg=#45475a]│ #[fg=#7f849c]%-m/%-d(%a) %-H:%M "

##### プラグイン設定 (TPM) ##############################################

# TPM (Tmux Plugin Manager)
set -g @plugin 'tmux-plugins/tpm'

# CPU・メモリ表示
set -g @plugin 'tmux-plugins/tmux-cpu'
set -g @cpu_percentage_format "%2.0f%%"
set -g @ram_percentage_format "%2.0f%%"

# バッテリー表示
set -g @plugin 'tmux-plugins/tmux-battery'

# バッテリーアイコン設定（テキスト表記）
set -g @batt_icon_status_charged 'CHG'
set -g @batt_icon_status_charging 'CHG'
set -g @batt_icon_status_discharging 'BAT'
set -g @batt_icon_status_unknown 'AC'

# セッション保存・復元
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @continuum-restore 'on'

# コピーモードからURL/ファイルを開く
set -g @plugin 'tmux-plugins/tmux-open'

# vim/tmux間をCtrl-hjklでシームレスに移動
set -g @plugin 'christoomey/vim-tmux-navigator'

# プレフィックスキー押下時にステータスバーをハイライト
set -g @plugin 'tmux-plugins/tmux-prefix-highlight'

# TPM初期化（この行は必ずファイル末尾に配置）
run '~/.tmux/plugins/tpm/tpm'
